// background.js - Service Worker

// Handle keyboard shortcuts
chrome.commands.onCommand.addListener((command) => {
  if (command === 'auto-correct') {
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      chrome.tabs.sendMessage(tabs[0].id, { action: 'autoCorrect' });
    });
  } else if (command === 'generate-code') {
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      chrome.tabs.sendMessage(tabs[0].id, { action: 'generateCode' });
    });
  }
});

// Listen for messages from content script or popup
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'autoCorrect') {
    handleAutoCorrect(request.code, sender.tab.id);
  } else if (request.action === 'generate') {
    handleGenerate(request.prompt, sender.tab.id);
  }
  return true;
});

async function handleAutoCorrect(code, tabId) {
  try {
    const keys = await chrome.storage.local.get(['geminiKey', 'huggingfaceKey']);
    const correctedCode = await autoCorrectCode(code, keys);
    
    chrome.tabs.sendMessage(tabId, {
      action: 'replaceCode',
      code: correctedCode
    });
  } catch (error) {
    console.error('Auto-correct failed:', error);
  }
}

async function handleGenerate(prompt, tabId) {
  try {
    const keys = await chrome.storage.local.get(['geminiKey', 'huggingfaceKey']);
    const code = await generateCode(prompt, keys);
    
    chrome.tabs.sendMessage(tabId, {
      action: 'insertCode',
      code: code
    });
  } catch (error) {
    console.error('Generate failed:', error);
  }
}

async function autoCorrectCode(code, keys) {
  const prompt = `Fix any syntax errors, bugs, or issues in this code. Return ONLY the corrected code without explanations:\n\n${code}`;
  
  // Try Gemini
  try {
    return await callGemini(prompt, 'gemini-1.5-flash', keys.geminiKey);
  } catch (err) {
    console.warn('Gemini failed:', err);
  }
  
  // Try HuggingFace
  try {
    return await callHuggingFace(prompt, keys.huggingfaceKey);
  } catch (err) {
    console.warn('HuggingFace failed:', err);
  }
  
  throw new Error('All AI models failed');
}

async function generateCode(prompt, keys) {
  // Try Gemini Flash
  try {
    return await callGemini(prompt, 'gemini-1.5-flash', keys.geminiKey);
  } catch (err) {
    console.warn('Gemini Flash failed:', err);
  }
  
  // Try Gemini Pro
  try {
    return await callGemini(prompt, 'gemini-1.5-pro', keys.geminiKey);
  } catch (err) {
    console.warn('Gemini Pro failed:', err);
  }
  
  // Try HuggingFace
  try {
    return await callHuggingFace(prompt, keys.huggingfaceKey);
  } catch (err) {
    console.warn('HuggingFace failed:', err);
  }
  
  throw new Error('All AI models failed');
}

async function callGemini(prompt, model, apiKey) {
  const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
  
  const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-goog-api-key': apiKey || ''
    },
    body: JSON.stringify({
      contents: [{
        parts: [{
          text: `Generate clean code for: ${prompt}. Return ONLY code, no explanations or markdown.`
        }]
      }],
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 2048
      }
    })
  });
  
  if (!response.ok) {
    throw new Error(`Gemini API error: ${response.status}`);
  }
  
  const data = await response.json();
  if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
    return data.candidates[0].content.parts[0].text;
  }
  
  throw new Error('No code generated by Gemini');
}

async function callHuggingFace(prompt, apiKey) {
  const response = await fetch('https://api-inference.huggingface.co/models/codellama/CodeLlama-34b-Instruct-hf', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey || ''}`
    },
    body: JSON.stringify({
      inputs: `Generate code: ${prompt}. Return only code.`,
      parameters: {
        max_new_tokens: 2048,
        temperature: 0.7,
        return_full_text: false
      }
    })
  });
  
  if (!response.ok) {
    throw new Error(`HuggingFace API error: ${response.status}`);
  }
  
  const data = await response.json();
  if (Array.isArray(data) && data[0]?.generated_text) {
    return data[0].generated_text;
  }
  
  throw new Error('No code generated by HuggingFace');
}

// Context menu for right-click
chrome.runtime.onInstalled.addListener(() => {
  chrome.contextMenus.create({
    id: 'ai-auto-correct',
    title: 'Auto-correct with AI',
    contexts: ['selection']
  });
  
  chrome.contextMenus.create({
    id: 'ai-generate',
    title: 'Generate code with AI',
    contexts: ['selection']
  });
});

chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === 'ai-auto-correct') {
    handleAutoCorrect(info.selectionText, tab.id);
  } else if (info.menuItemId === 'ai-generate') {
    chrome.tabs.sendMessage(tab.id, { action: 'generateCode' });
  }
});
